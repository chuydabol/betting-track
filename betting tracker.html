<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CHUYITO230 Daily Slip & Prop Tracker</title>
  <style>
    :root{
      color-scheme: dark;
      --bg: #070b13;
      --panel: rgba(255,255,255,0.06);
      --panel-strong: rgba(255,255,255,0.09);
      --border: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.9);
      --muted: rgba(255,255,255,0.6);
      --muted-2: rgba(255,255,255,0.45);
      --accent: #6ea8ff;
      --accent-2: #8b5cf6;
      --good: #4ade80;
      --bad: #fb7185;
      --warn: #facc15;
      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin: 0;
      font-family: var(--sans);
      background:
        radial-gradient(900px 540px at 15% 0%, rgba(110,168,255,.12), transparent 60%),
        radial-gradient(700px 420px at 85% 10%, rgba(139,92,246,.12), transparent 55%),
        var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    .wrap{ max-width: 1320px; margin: 24px auto 80px; padding: 0 16px; }
    .topbar{
      position: sticky;
      top: 0;
      z-index: 40;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(7,11,19,.9), rgba(7,11,19,.6));
      border-bottom: 1px solid var(--border);
    }
    .topbar-inner{
      max-width: 1320px;
      margin: 0 auto;
      padding: 14px 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }
    .brand{
      display: grid;
      gap: 6px;
    }
    .brand h1{ margin: 0; font-size: 20px; letter-spacing: .4px; }
    .brand .sub{ color: var(--muted); font-size: 12px; }

    .actions{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .btn{
      appearance: none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{ background: rgba(255,255,255,0.12); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(110,168,255,.95), rgba(139,92,246,.9));
      color: #05070d;
      border-color: rgba(255,255,255,0.2);
    }
    .btn.ghost{ background: transparent; }

    input, select, textarea{
      width: 100%;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea{ min-height: 80px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(110,168,255,.6);
      box-shadow: 0 0 0 3px rgba(110,168,255,.18);
    }
    label{ font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }

    .grid{
      display: grid;
      grid-template-columns: minmax(0, 2.3fr) minmax(0, 1.2fr);
      gap: 18px;
      margin-top: 18px;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .section-title{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .section-title h2{ margin: 0; font-size: 15px; }
    .hint{ color: var(--muted); font-size: 12px; }

    .row{
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(12, minmax(0, 1fr));
    }
    .col-3{ grid-column: span 3; }
    .col-4{ grid-column: span 4; }
    .col-6{ grid-column: span 6; }
    .col-8{ grid-column: span 8; }
    .col-12{ grid-column: span 12; }
    @media (max-width: 980px){
      .row{ grid-template-columns: repeat(6, minmax(0, 1fr)); }
      .col-3,.col-4,.col-6,.col-8{ grid-column: span 6; }
    }

    .kpis{
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
    @media (max-width: 900px){
      .kpis{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .kpi{
      padding: 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
    }
    .kpi .k{ font-size: 11px; color: var(--muted-2); text-transform: uppercase; letter-spacing: .12em; }
    .kpi .v{ font-size: 18px; font-weight: 800; margin-top: 6px; }
    .pos{ color: var(--good); }
    .neg{ color: var(--bad); }

    .calendar{
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .calendar .btn{ min-height: 38px; }
    .calendar input[type="date"]{ min-width: 180px; }

    .slip-list{
      display: grid;
      gap: 12px;
    }
    .slip-item{
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      padding: 12px;
      display: grid;
      gap: 10px;
    }
    .slip-head{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .pill{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
    }
    .pill.win{ border-color: rgba(74,222,128,.35); color: var(--good); }
    .pill.loss{ border-color: rgba(251,113,133,.35); color: var(--bad); }
    .pill.pending{ border-color: rgba(250,204,21,.35); color: var(--warn); }

    .slip-meta{
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      font-size: 12px;
      color: var(--muted);
    }
    .slip-meta strong{ color: var(--text); }

    .props{
      border-left: 2px solid rgba(110,168,255,.4);
      padding-left: 10px;
      display: grid;
      gap: 6px;
      font-size: 12px;
    }
    .prop{ display: flex; justify-content: space-between; gap: 8px; }
    .prop .name{ font-weight: 700; }

    .chart-wrap{
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      padding: 12px;
      background: rgba(255,255,255,0.04);
    }
    canvas{ width: 100%; height: 220px; display: block; }

    .info-box{
      display: grid;
      gap: 8px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      padding: 12px;
      font-size: 12px;
      color: var(--muted);
    }
    .mono{ font-family: var(--mono); }

    .muteline{ color: var(--muted-2); font-size: 12px; }
    .actions-inline{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tag{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 11px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <h1>CHUYITO230 Tracker</h1>
        <div class="sub">Daily slips + prop hits, unit math, follower bankroll projection.</div>
      </div>
      <div class="actions">
        <button class="btn primary" id="openEntry">+ Add Slip</button>
        <button class="btn" id="exportTxt">Export TXT</button>
        <label class="btn ghost" style="gap:8px;">
          Import
          <input id="importTxt" type="file" accept=".txt,.json" hidden>
        </label>
        <button class="btn" id="clearAll">Reset All</button>
      </div>
    </div>
  </div>

  <main class="wrap">
    <div class="grid">
      <div class="left-col">
        <section class="card">
          <div class="section-title">
            <h2>Daily Calendar</h2>
            <span class="hint">Track every day with a calendar view.</span>
          </div>
          <div class="calendar">
            <button class="btn" id="prevDay">◀</button>
            <input type="date" id="dayPicker" />
            <button class="btn" id="nextDay">▶</button>
            <button class="btn ghost" id="todayBtn">Today</button>
          </div>
          <div class="muteline" id="daySummary"></div>
        </section>

        <section class="card" id="entryCard" hidden>
          <div class="section-title">
            <h2>Add / Edit Slip</h2>
            <span class="hint">Units = 5% of bankroll. 1 unit @ 3x = +3 units if it hits.</span>
          </div>
          <div class="row">
            <div class="col-3">
              <label for="slipDate">Date</label>
              <input type="date" id="slipDate" />
            </div>
            <div class="col-3">
              <label for="slipStatus">Status</label>
              <select id="slipStatus">
                <option value="PENDING">Pending</option>
                <option value="DONE">Finished</option>
              </select>
            </div>
            <div class="col-3">
              <label for="slipResult">Result</label>
              <select id="slipResult">
                <option value="WIN">Win</option>
                <option value="LOSS">Loss</option>
                <option value="PUSH">Push</option>
              </select>
            </div>
            <div class="col-3">
              <label for="slipType">Slip Type</label>
              <input id="slipType" placeholder="Parlay / Straight" />
            </div>
            <div class="col-3">
              <label for="unitStake">Units Risked</label>
              <input id="unitStake" type="number" step="0.1" min="0" placeholder="0.5" />
            </div>
            <div class="col-3">
              <label for="multiplier">Multiplier (x)</label>
              <input id="multiplier" type="number" step="0.01" min="0" placeholder="3" />
            </div>
            <div class="col-3">
              <label for="slipBook">Sportsbook/App</label>
              <input id="slipBook" placeholder="PrizePicks" />
            </div>
            <div class="col-3">
              <label for="slipNotes">Notes</label>
              <input id="slipNotes" placeholder="3 leg NBA" />
            </div>
            <div class="col-12">
              <label>Props (one per line: Player — Prop — Result)</label>
              <textarea id="propsInput" placeholder="Shai Gilgeous-Alexander — O 29.5 PTS — Hit"></textarea>
            </div>
          </div>
          <div class="actions-inline" style="margin-top:12px;">
            <button class="btn primary" id="saveSlip">Save Slip</button>
            <button class="btn" id="cancelSlip">Cancel</button>
          </div>
        </section>

        <section class="card">
          <div class="section-title">
            <h2>Slips on <span id="dayLabel"></span></h2>
            <span class="hint">Tap a slip to edit or update the result.</span>
          </div>
          <div class="slip-list" id="slipList"></div>
        </section>
      </div>

      <div class="right-col">
        <section class="card">
          <div class="section-title">
            <h2>Daily + Overall Stats</h2>
            <span class="hint">Unit math with 5% bankroll sizing.</span>
          </div>
          <div class="kpis" id="kpiGrid"></div>
          <div class="info-box" style="margin-top:12px;">
            <div><strong>Unit Rule:</strong> 1 unit = 5% of bankroll.</div>
            <div><strong>Win math:</strong> units × multiplier = units won.</div>
            <div><strong>Loss math:</strong> -units risked.</div>
          </div>
        </section>

        <section class="card">
          <div class="section-title">
            <h2>Follower Bankroll Projection</h2>
            <span class="hint">Show how followers would perform.</span>
          </div>
          <div class="row">
            <div class="col-6">
              <label for="followerBank">Follower Bankroll ($)</label>
              <input id="followerBank" type="number" min="0" step="1" value="200" />
            </div>
            <div class="col-6">
              <label for="bankrollStart">Your Starting Bankroll ($)</label>
              <input id="bankrollStart" type="number" min="0" step="1" value="1000" />
            </div>
            <div class="col-12">
              <div class="info-box" id="bankrollSummary"></div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="section-title">
            <h2>Charts</h2>
            <span class="hint">Live charts update with each slip.</span>
          </div>
          <div class="chart-wrap">
            <div class="muteline">Cumulative Units (all time)</div>
            <canvas id="unitsChart" width="600" height="240"></canvas>
          </div>
          <div class="chart-wrap" style="margin-top:12px;">
            <div class="muteline">Daily Units (last 14 days)</div>
            <canvas id="dailyChart" width="600" height="240"></canvas>
          </div>
        </section>
      </div>
    </div>
  </main>

  <script>
    const DEFAULT_STATE = {
      slips: [],
      selectedDate: todayISO(),
      bankrollStart: 1000,
      followerBank: 200
    };

    let state = loadState();
    let editingId = null;

    const $ = (id) => document.getElementById(id);

    function todayISO(){
      return new Date().toISOString().slice(0,10);
    }

    function loadState(){
      const saved = localStorage.getItem("chuyito-tracker");
      if(!saved) return {...DEFAULT_STATE};
      try{
        const parsed = JSON.parse(saved);
        return {
          ...DEFAULT_STATE,
          ...parsed,
          slips: Array.isArray(parsed.slips) ? parsed.slips : []
        };
      }catch{
        return {...DEFAULT_STATE};
      }
    }

    function saveState(){
      localStorage.setItem("chuyito-tracker", JSON.stringify(state));
    }

    function formatUnits(value){
      const rounded = Math.round(value * 100) / 100;
      return `${rounded.toFixed(2)}u`;
    }

    function formatMoney(value){
      return new Intl.NumberFormat("en-US", {style: "currency", currency: "USD"}).format(value);
    }

    function unitsProfit(slip){
      if(slip.status !== "DONE") return 0;
      if(slip.result === "WIN") return slip.units * slip.multiplier;
      if(slip.result === "LOSS") return -slip.units;
      return 0;
    }

    function parseProps(text){
      if(!text.trim()) return [];
      return text.split("\n").map(line => {
        const [name, prop, result] = line.split("—").map(part => (part || "").trim());
        return { name, prop, result };
      }).filter(item => item.name || item.prop || item.result);
    }

    function propsToText(props){
      return props.map(p => [p.name, p.prop, p.result].filter(Boolean).join(" — ")).join("\n");
    }

    function updateDayLabel(){
      const date = new Date(state.selectedDate);
      $("dayLabel").textContent = date.toLocaleDateString("en-US", {weekday: "long", month: "short", day: "numeric"});
    }

    function slipsForDate(date){
      return state.slips.filter(s => s.date === date);
    }

    function summaryFor(slips){
      const totalUnits = slips.reduce((sum, slip) => sum + unitsProfit(slip), 0);
      const wins = slips.filter(s => s.status === "DONE" && s.result === "WIN").length;
      const losses = slips.filter(s => s.status === "DONE" && s.result === "LOSS").length;
      const pending = slips.filter(s => s.status === "PENDING").length;
      const props = slips.flatMap(s => s.props || []);
      const propHits = props.filter(p => (p.result || "").toLowerCase().includes("hit")).length;
      const propMisses = props.filter(p => (p.result || "").toLowerCase().includes("miss") || (p.result || "").toLowerCase().includes("loss")).length;
      return { totalUnits, wins, losses, pending, propHits, propMisses };
    }

    function updateKpis(){
      const daySlips = slipsForDate(state.selectedDate);
      const daySummary = summaryFor(daySlips);
      const overallSummary = summaryFor(state.slips);

      const kpis = [
        { label: "Today Units", value: daySummary.totalUnits, type: "units" },
        { label: "Overall Units", value: overallSummary.totalUnits, type: "units" },
        { label: "Today Slips", value: daySlips.length, type: "count" },
        { label: "Pending", value: daySummary.pending, type: "count" },
        { label: "Wins", value: overallSummary.wins, type: "count" },
        { label: "Losses", value: overallSummary.losses, type: "count" },
        { label: "Prop Hits", value: overallSummary.propHits, type: "count" },
        { label: "Prop Misses", value: overallSummary.propMisses, type: "count" }
      ];

      const grid = $("kpiGrid");
      grid.innerHTML = "";
      kpis.forEach(kpi => {
        const div = document.createElement("div");
        div.className = "kpi";
        const value = kpi.type === "units" ? formatUnits(kpi.value) : kpi.value;
        const cls = kpi.type === "units" ? (kpi.value >= 0 ? "pos" : "neg") : "";
        div.innerHTML = `<div class="k">${kpi.label}</div><div class="v ${cls}">${value}</div>`;
        grid.appendChild(div);
      });

      $("daySummary").textContent = `Today: ${daySlips.length} slips • ${formatUnits(daySummary.totalUnits)} units`;
    }

    function renderSlipList(){
      const container = $("slipList");
      const slips = slipsForDate(state.selectedDate);
      if(!slips.length){
        container.innerHTML = `<div class="muteline">No slips logged for this day yet.</div>`;
        return;
      }
      container.innerHTML = "";
      slips.forEach(slip => {
        const item = document.createElement("div");
        item.className = "slip-item";
        item.innerHTML = `
          <div class="slip-head">
            <div>
              <strong>${slip.notes || slip.type || "Slip"}</strong>
              <div class="muteline">${slip.book || ""}</div>
            </div>
            <span class="pill ${slip.status === "PENDING" ? "pending" : slip.result === "WIN" ? "win" : slip.result === "LOSS" ? "loss" : ""}">
              ${slip.status === "PENDING" ? "Pending" : slip.result}
            </span>
          </div>
          <div class="slip-meta">
            <div>Units: <strong>${formatUnits(slip.units)}</strong></div>
            <div>Multiplier: <strong>${slip.multiplier}x</strong></div>
            <div>Units P/L: <strong class="${unitsProfit(slip) >= 0 ? "pos" : "neg"}">${formatUnits(unitsProfit(slip))}</strong></div>
            <div>Props: <strong>${(slip.props || []).length}</strong></div>
          </div>
          ${slip.props && slip.props.length ? `
            <div class="props">
              ${slip.props.map(prop => `
                <div class="prop">
                  <div class="name">${prop.name || "Prop"}</div>
                  <div class="muteline">${prop.prop || ""}</div>
                  <div>${prop.result || ""}</div>
                </div>
              `).join("")}
            </div>
          ` : ""}
          <div class="actions-inline">
            <button class="btn" data-action="edit" data-id="${slip.id}">Edit</button>
            <button class="btn" data-action="win" data-id="${slip.id}">Mark Win</button>
            <button class="btn" data-action="loss" data-id="${slip.id}">Mark Loss</button>
            <button class="btn" data-action="pending" data-id="${slip.id}">Pending</button>
            <button class="btn" data-action="delete" data-id="${slip.id}">Delete</button>
          </div>
        `;
        container.appendChild(item);
      });
    }

    function updateBankrollSummary(){
      const followerBank = Number($("followerBank").value) || 0;
      const bankrollStart = Number($("bankrollStart").value) || 0;
      state.followerBank = followerBank;
      state.bankrollStart = bankrollStart;
      saveState();

      const unitValue = followerBank * 0.05;
      const totalUnits = state.slips.reduce((sum, slip) => sum + unitsProfit(slip), 0);
      const followerPnL = totalUnits * unitValue;
      const followerBalance = followerBank + followerPnL;

      $("bankrollSummary").innerHTML = `
        <div>Follower Unit Size: <strong>${formatMoney(unitValue)}</strong></div>
        <div>Total Units: <strong class="${totalUnits >= 0 ? "pos" : "neg"}">${formatUnits(totalUnits)}</strong></div>
        <div>Follower P/L: <strong class="${followerPnL >= 0 ? "pos" : "neg"}">${formatMoney(followerPnL)}</strong></div>
        <div>Follower Balance: <strong>${formatMoney(followerBalance)}</strong></div>
      `;
    }

    function drawLineChart(canvas, values, labelFormatter){
      const ctx = canvas.getContext("2d");
      const {width, height} = canvas;
      ctx.clearRect(0,0,width,height);
      ctx.fillStyle = "rgba(255,255,255,0.55)";
      ctx.font = "12px ui-sans-serif";

      if(values.length === 0){
        ctx.fillText("No data yet.", 12, 20);
        return;
      }

      const padding = 24;
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = Math.max(1, max - min);

      ctx.strokeStyle = "rgba(255,255,255,0.2)";
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, height - padding);
      ctx.lineTo(width - padding, height - padding);
      ctx.stroke();

      ctx.strokeStyle = "rgba(110,168,255,0.85)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      values.forEach((val, idx) => {
        const x = padding + (idx / Math.max(1, values.length - 1)) * (width - padding * 2);
        const y = height - padding - ((val - min) / range) * (height - padding * 2);
        if(idx === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,0.7)";
      ctx.font = "12px ui-monospace";
      ctx.fillText(labelFormatter(values[values.length - 1]), padding, height - 8);
    }

    function drawBarChart(canvas, series){
      const ctx = canvas.getContext("2d");
      const {width, height} = canvas;
      ctx.clearRect(0,0,width,height);
      ctx.fillStyle = "rgba(255,255,255,0.55)";
      ctx.font = "12px ui-sans-serif";
      if(series.length === 0){
        ctx.fillText("No data yet.", 12, 20);
        return;
      }

      const padding = 24;
      const values = series.map(item => item.value);
      const max = Math.max(1, Math.max(...values.map(v => Math.abs(v))));
      const barWidth = (width - padding * 2) / series.length;

      ctx.strokeStyle = "rgba(255,255,255,0.2)";
      ctx.beginPath();
      ctx.moveTo(padding, height - padding);
      ctx.lineTo(width - padding, height - padding);
      ctx.stroke();

      series.forEach((item, idx) => {
        const x = padding + idx * barWidth + barWidth * 0.2;
        const barHeight = (Math.abs(item.value) / max) * (height - padding * 2);
        const y = height - padding - barHeight;
        ctx.fillStyle = item.value >= 0 ? "rgba(74,222,128,0.7)" : "rgba(251,113,133,0.7)";
        ctx.fillRect(x, y, barWidth * 0.6, barHeight);
      });
    }

    function renderCharts(){
      const sorted = [...state.slips].sort((a,b) => a.date.localeCompare(b.date));
      let running = 0;
      const cumulative = [];
      sorted.forEach(slip => {
        running += unitsProfit(slip);
        cumulative.push(running);
      });
      drawLineChart($("unitsChart"), cumulative, (val) => `End: ${formatUnits(val)}`);

      const last14 = [];
      const now = new Date(state.selectedDate);
      for(let i=13; i>=0; i--){
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const iso = d.toISOString().slice(0,10);
        const units = slipsForDate(iso).reduce((sum, slip) => sum + unitsProfit(slip), 0);
        last14.push({ date: iso, value: units });
      }
      drawBarChart($("dailyChart"), last14);
    }

    function renderAll(){
      updateDayLabel();
      updateKpis();
      renderSlipList();
      updateBankrollSummary();
      renderCharts();
      saveState();
    }

    function openEntry(slip){
      $("entryCard").hidden = false;
      $("slipDate").value = slip?.date || state.selectedDate;
      $("slipStatus").value = slip?.status || "PENDING";
      $("slipResult").value = slip?.result || "WIN";
      $("slipResult").disabled = $("slipStatus").value !== "DONE";
      $("slipType").value = slip?.type || "";
      $("unitStake").value = slip?.units ?? "";
      $("multiplier").value = slip?.multiplier ?? "";
      $("slipBook").value = slip?.book || "";
      $("slipNotes").value = slip?.notes || "";
      $("propsInput").value = slip?.props ? propsToText(slip.props) : "";
      editingId = slip?.id || null;
    }

    function closeEntry(){
      $("entryCard").hidden = true;
      editingId = null;
    }

    function saveSlip(){
      const slip = {
        id: editingId || crypto.randomUUID(),
        date: $("slipDate").value || state.selectedDate,
        status: $("slipStatus").value,
        result: $("slipResult").value,
        type: $("slipType").value.trim(),
        units: Number($("unitStake").value) || 0,
        multiplier: Number($("multiplier").value) || 0,
        book: $("slipBook").value.trim(),
        notes: $("slipNotes").value.trim(),
        props: parseProps($("propsInput").value)
      };
      if(slip.units <= 0 || slip.multiplier <= 0){
        alert("Enter units and multiplier.");
        return;
      }
      if(slip.status !== "DONE") slip.result = "PENDING";

      if(editingId){
        const idx = state.slips.findIndex(s => s.id === editingId);
        if(idx !== -1) state.slips[idx] = slip;
      }else{
        state.slips.push(slip);
      }
      closeEntry();
      renderAll();
    }

    function updateSlipStatus(id, status, result){
      const slip = state.slips.find(s => s.id === id);
      if(!slip) return;
      slip.status = status;
      slip.result = status === "DONE" ? result : "PENDING";
      renderAll();
    }

    function deleteSlip(id){
      state.slips = state.slips.filter(s => s.id !== id);
      renderAll();
    }

    function exportTxt(){
      const payload = {
        version: 1,
        exportedAt: new Date().toISOString(),
        state
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type: "text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `chuyito-tracker-${todayISO()}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function importTxt(file){
      const text = await file.text();
      const parsed = JSON.parse(text);
      if(parsed.state){
        state = {
          ...DEFAULT_STATE,
          ...parsed.state,
          slips: Array.isArray(parsed.state.slips) ? parsed.state.slips : []
        };
      }else if(parsed.slips){
        state = {
          ...DEFAULT_STATE,
          ...parsed,
          slips: Array.isArray(parsed.slips) ? parsed.slips : []
        };
      }
      renderAll();
    }

    $("openEntry").addEventListener("click", () => openEntry());
    $("cancelSlip").addEventListener("click", closeEntry);
    $("saveSlip").addEventListener("click", saveSlip);

    $("slipStatus").addEventListener("change", (e) => {
      $("slipResult").disabled = e.target.value !== "DONE";
    });

    $("prevDay").addEventListener("click", () => {
      const date = new Date(state.selectedDate);
      date.setDate(date.getDate() - 1);
      state.selectedDate = date.toISOString().slice(0,10);
      $("dayPicker").value = state.selectedDate;
      renderAll();
    });

    $("nextDay").addEventListener("click", () => {
      const date = new Date(state.selectedDate);
      date.setDate(date.getDate() + 1);
      state.selectedDate = date.toISOString().slice(0,10);
      $("dayPicker").value = state.selectedDate;
      renderAll();
    });

    $("todayBtn").addEventListener("click", () => {
      state.selectedDate = todayISO();
      $("dayPicker").value = state.selectedDate;
      renderAll();
    });

    $("dayPicker").addEventListener("change", (e) => {
      state.selectedDate = e.target.value || todayISO();
      renderAll();
    });

    $("followerBank").addEventListener("input", updateBankrollSummary);
    $("bankrollStart").addEventListener("input", updateBankrollSummary);

    $("exportTxt").addEventListener("click", exportTxt);
    $("importTxt").addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if(file) await importTxt(file);
      e.target.value = "";
    });

    $("clearAll").addEventListener("click", () => {
      if(!confirm("This wipes all slips. Continue?")) return;
      state = {...DEFAULT_STATE, selectedDate: state.selectedDate};
      renderAll();
    });

    $("slipList").addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if(!btn) return;
      const id = btn.dataset.id;
      if(btn.dataset.action === "edit"){
        const slip = state.slips.find(s => s.id === id);
        openEntry(slip);
      }
      if(btn.dataset.action === "win") updateSlipStatus(id, "DONE", "WIN");
      if(btn.dataset.action === "loss") updateSlipStatus(id, "DONE", "LOSS");
      if(btn.dataset.action === "pending") updateSlipStatus(id, "PENDING", "PENDING");
      if(btn.dataset.action === "delete") deleteSlip(id);
    });

    $("dayPicker").value = state.selectedDate;
    $("followerBank").value = state.followerBank;
    $("bankrollStart").value = state.bankrollStart;
    updateDayLabel();
    renderAll();
  </script>
</body>
</html>
