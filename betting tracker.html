<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Slip Tracker — Multipliers</title>
  <style>
    :root{
      --bg: #0b0f19;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --muted2: rgba(255,255,255,0.45);
      --accent: #6ea8ff;
      --accent2:#8b5cf6;
      --good:#4ade80;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 12px;
      --pad: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(110,168,255,.18), transparent 60%),
        radial-gradient(700px 500px at 85% 10%, rgba(139,92,246,.14), transparent 55%),
        var(--bg);
      color: var(--text);
      overflow-x: hidden; /* important: prevents page-level horizontal scroll */
    }

    .wrap{ max-width: 1200px; margin: 16px auto 60px; padding: 0 14px; }
    .skip-link{
      position: absolute;
      top: -40px;
      left: 12px;
      background: #111827;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      z-index: 1001;
      transition: top .15s ease;
    }
    .skip-link:focus{ top: 10px; }
    .sr-only{
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    /* Topbar */
    .topbar{
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,15,25,.82), rgba(11,15,25,.35));
      border-bottom: 1px solid var(--border);
      padding: 10px 0;
    }
    .topbar .inner{
      max-width: 1200px; margin: 0 auto; padding: 0 14px;
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
    }
    .brand{ display:flex; flex-direction:column; gap:2px; min-width: 180px; }
    .brand h1{ margin:0; font-size: 16px; letter-spacing:.2px; }
    .brand .sub{ font-size: 12px; color: var(--muted); }

    .top-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    /* Buttons & inputs */
    .btn{
      appearance:none; border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      font-weight: 700;
      font-size: 13px;
      line-height: 1;
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      min-height: 40px;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,0.10); }
    .btn:active{ transform: translateY(1px); }
    .btn:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible,
    .kebab:focus-visible{
      outline: 2px solid rgba(110,168,255,.7);
      outline-offset: 2px;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(110,168,255,.95), rgba(139,92,246,.85));
      border-color: rgba(255,255,255,0.18);
      color: #0b0f19;
    }
    .btn.danger{
      background: rgba(251,113,133,.13);
      border-color: rgba(251,113,133,.25);
      color: rgba(255,255,255,.95);
    }
    .btn.ghost{ background: transparent; }

    input, select, textarea{
      width:100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      min-height: 40px;
      font-size: 14px;
    }
    textarea{ min-height: 72px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(110,168,255,.55);
      box-shadow: 0 0 0 3px rgba(110,168,255,.18);
    }
    label{ font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
      min-width: 0; /* critical for grid overflow */
    }

    /* Responsive layout */
    .grid{
      display:grid; gap: 14px;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, .7fr);
      margin-top: 16px;
      align-items:start;
    }
    @media (max-width: 1180px){
      .grid{ grid-template-columns: 1fr; }
    }

    .row{
      display:grid; gap: 10px;
      grid-template-columns: repeat(12, minmax(0, 1fr));
    }
    .col-3{ grid-column: span 3; }
    .col-4{ grid-column: span 4; }
    .col-6{ grid-column: span 6; }
    .col-12{ grid-column: span 12; }

    @media (max-width: 980px){
      .row{ grid-template-columns: repeat(6, minmax(0, 1fr)); }
      .col-3,.col-4,.col-6{ grid-column: span 6; }
    }

    .section-title{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap:wrap;
    }
    .section-title h2{ margin:0; font-size: 14px; letter-spacing:.2px; }
    .hint{ color: var(--muted); font-size: 12px; }

    /* KPIs */
    .kpis{
      display:grid; gap: 10px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      margin-top: 10px;
    }
    @media (min-width: 560px){
      .kpis{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    .kpi{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      border-radius: 14px;
      padding: 12px;
      min-width: 0;
    }
    .kpi .k{ font-size: 12px; color: var(--muted); }
    .kpi .v{ margin-top: 6px; font-size: 18px; font-weight: 900; }
    .pos{ color: var(--good); }
    .neg{ color: var(--bad); }
    .neu{ color: var(--warn); }
    .bankline{ margin-top: 10px; color: var(--muted); font-size: 12px; }
    .chart-wrap{
      margin-top: 12px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
    }
    #bankrollChart{
      width: 100%;
      height: 180px;
      display: block;
    }

    /* Table wrapper: prevents page overflow */
    .tablewrap{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      background: rgba(255,255,255,0.03);
      min-width: 0;
    }
    .table-scroll{
      max-height: 460px;
      overflow: auto;              /* vertical + horizontal inside */
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }
    table{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;         /* stops columns from forcing huge widths */
      min-width: 860px;            /* only the inner scroller scrolls horizontally */
    }
    th, td{
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 10px 10px;
      font-size: 13px;
      vertical-align: top;
      text-align:left;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th{
      position: sticky; top: 0; z-index: 5;
      background: rgba(11,15,25,.88);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,0.78);
      font-size: 12px;
      letter-spacing: .2px;
    }
    td.right, th.right{ text-align:right; }
    .mono{ font-family: var(--mono); }
    caption{
      text-align:left;
      padding: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    /* Players truncate in table */
    .notes-trunc{
      white-space: nowrap;
      max-width: 340px;
    }

    /* Pills */
    .pill{
      display:inline-flex; align-items:center; gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      white-space: nowrap;
    }
    .pill.pending{ border-color: rgba(251,191,36,.22); background: rgba(251,191,36,.10); }
    .pill.win{ border-color: rgba(74,222,128,.22); background: rgba(74,222,128,.10); }
    .pill.loss{ border-color: rgba(251,113,133,.22); background: rgba(251,113,133,.10); }
    .pill.push{ border-color: rgba(110,168,255,.22); background: rgba(110,168,255,.10); }

    /* Kebab actions */
    .kebab{
      width: 38px; height: 38px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.88);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size: 18px;
      line-height: 1;
    }
    .kebab:hover{ background: rgba(255,255,255,0.10); }

    .muteline{ color: var(--muted); font-size: 12px; margin-top: 8px; }

    /* Log view toggles */
    .log-views{ display:flex; gap: 8px; align-items:center; flex-wrap:wrap; }
    .smalltag{ font-size: 12px; color: var(--muted); }

    /* Cards log */
    .cardsWrap{ display:none; gap: 10px; margin-top: 10px; }
    .slipCard{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 12px;
      display:grid;
      gap: 10px;
    }
    .slipCard .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .slipCard .meta{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color: rgba(255,255,255,0.8);
      font-size: 13px;
    }
    .slipCard .meta .mono{ color: rgba(255,255,255,0.9); }
    .slipCard .grid2{
      display:grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    .slipCard .kv{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      border-radius: 14px;
      padding: 10px;
      min-width: 0;
    }
    .slipCard .kv .k{ font-size: 12px; color: var(--muted); }
    .slipCard .kv .v{ margin-top: 4px; font-weight: 900; }
    .slipCard .notes{
      white-space: pre-wrap;
      color: rgba(255,255,255,0.82);
      border-top: 1px solid rgba(255,255,255,0.10);
      padding-top: 10px;
      font-size: 13px;
    }
    @media (max-width: 520px){
      .slipCard .grid2{ grid-template-columns: 1fr; }
    }

    /* Show cards on small screens (auto mode) */
    body.view-auto .cardsWrap{ display: grid; }
    body.view-auto .tablewrap{ display:none; }
    @media (min-width: 900px){
      body.view-auto .cardsWrap{ display:none; }
      body.view-auto .tablewrap{ display:block; }
    }

    body.view-table .cardsWrap{ display:none !important; }
    body.view-table .tablewrap{ display:block !important; }

    body.view-cards .cardsWrap{ display:grid !important; }
    body.view-cards .tablewrap{ display:none !important; }

    /* Floating menu / bottom sheet */
    .menu{
      position: fixed;
      z-index: 1000;
      width: 330px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(17,24,39,.88);
      backdrop-filter: blur(12px);
      box-shadow: 0 20px 55px rgba(0,0,0,.55);
      padding: 10px;
      display:none;
      max-width: calc(100vw - 20px);
    }
    .menu .title{
      display:flex; align-items:center; justify-content:space-between;
      gap: 8px;
      padding: 6px 6px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      margin-bottom: 10px;
    }
    .menu .title .t{ font-weight: 900; font-size: 13px; }
    .menu .title .x{
      border:none; background: transparent; color: rgba(255,255,255,.85);
      font-size: 18px; cursor:pointer;
    }
    .menu .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .menu .grid1{ display:grid; gap: 8px; }
    .menu small{ color: rgba(255,255,255,0.65); }
    .menu .line{ border-top: 1px solid rgba(255,255,255,0.10); margin: 10px 0; }

    /* bottom sheet on mobile */
    @media (max-width: 600px){
      .menu{
        left: 10px !important;
        right: 10px !important;
        bottom: 10px !important;
        top: auto !important;
        width: auto !important;
        border-radius: 18px;
      }
    }

    @media (prefers-reduced-motion: reduce){
      *{
        scroll-behavior: auto !important;
        transition-duration: 0.001ms !important;
      }
    }
  </style>
</head>

<body class="view-auto">
  <a class="skip-link" href="#main">Skip to content</a>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <h1>Slip Tracker</h1>
        <div class="sub">player props • multipliers • pending slips • import/export</div>
      </div>
      <div class="top-actions">
        <button class="btn" id="exportBtn">Export TXT</button>
        <button class="btn" id="exportCsvBtn">Export CSV</button>
        <label class="btn ghost" style="gap:10px; padding:10px 12px;">
          Import
          <input id="importFile" type="file" accept=".txt,.json" style="display:none;">
        </label>
      </div>
    </div>
  </div>

  <main class="wrap" id="main">
    <div class="grid">
      <!-- Left -->
      <div class="card">
        <div class="section-title">
          <h2>Add Slip</h2>
          <span class="hint">Add as Pending, finish later</span>
        </div>

        <div class="row" role="group" aria-label="Add slip form">
          <div class="col-3">
            <label for="date">Date</label>
            <input id="date" type="date" />
          </div>
          <div class="col-3">
            <label for="status">Status</label>
            <select id="status" aria-describedby="statusHelp">
              <option value="PENDING">Pending</option>
              <option value="DONE">Finished</option>
            </select>
            <div class="muteline" id="statusHelp">Set to Finished to unlock the result field.</div>
          </div>
          <div class="col-3">
            <label for="result">Result (only if finished)</label>
            <select id="result" aria-describedby="resultHelp">
              <option value="W">Win</option>
              <option value="L">Loss</option>
              <option value="P">Push</option>
            </select>
            <div class="muteline" id="resultHelp">Disabled unless Status is Finished.</div>
          </div>
          <div class="col-3">
            <label for="app">App (optional)</label>

          </div>
          <div class="col-3">
            <label for="oddsType">Odds Type (optional)</label>
            <select id="oddsType">
              <option value="">Select</option>
              <option value="standard">Standard</option>
              <option value="boost">Boost</option>
              <option value="promo">Promo</option>
            </select>
          </div>
          <div class="col-3">
            <label for="creator">Slip Made By</label>
            <select id="creator">
              <option value="CHUY">CHUY (me)</option>
              <option value="ENVIXITY">ENVIXITY</option>
              <option value="JAY">JAY</option>
              <option value="OCHAN">OCHAN</option>
              <option value="FLUID">FLUID</option>
              <option value="POPS">POPS</option>
              <option value="MIX">MIX (combined)</option>
            </select>
          </div>

          <div class="col-3">
            <label for="stake">Stake ($)</label>
            <input id="stake" type="number" step="0.01" placeholder="50" min="0.01" inputmode="decimal" />

          </div>

          <div class="col-6">
            <label for="slipId">Slip ID (optional)</label>

          </div>

          <div class="col-12" style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" id="addBtn" style="flex: 1 1 220px;">Add Slip</button>
            <button class="btn" id="addPendingBtn" style="flex: 1 1 220px;">Quick Add Pending</button>
            <button class="btn danger" id="clearBtn" style="flex: 1 1 220px;">Clear All</button>
          </div>
        </div>

        <div class="muteline">
          Finished payout: <span class="mono">stake × (paid x if set else listed x)</span>. Pending slips don’t affect profit.
        </div>

        <datalist id="appList"></datalist>
        <datalist id="sportsbookList"></datalist>
        <datalist id="leagueList"></datalist>
        <datalist id="tagList"></datalist>
        <datalist id="groupList"></datalist>
        <datalist id="slipIdList"></datalist>

        <div style="height:14px"></div>

        <div class="section-title">
          <h2>Slip Log</h2>
          <div class="log-views">
            <span class="smalltag">View</span>
            <select id="logView" style="width: 150px;">
              <option value="auto">Auto</option>
              <option value="table">Table</option>
              <option value="cards">Cards</option>
            </select>
            <span class="hint">Use ⋯ for actions</span>
          </div>
        </div>

        <!-- TABLE VIEW -->
        <div class="tablewrap">
          <div class="table-scroll">
            <table>

              <thead>
                <tr>
                  <th scope="col" style="width: 96px;">Date</th>
                  <th scope="col" style="width: 110px;">Status</th>
                  <th scope="col" style="width: 120px;">App</th>
                  <th scope="col" style="width: 120px;">Sportsbook</th>
                  <th scope="col" style="width: 90px;">League</th>
                  <th scope="col" style="width: 90px;">Odds</th>

                  <th scope="col" class="right" style="width: 92px;">Stake</th>
                  <th scope="col" class="right" style="width: 72px;">x</th>
                  <th scope="col" class="right" style="width: 92px;">Paid x</th>
                  <th scope="col" class="right" style="width: 100px;">Payout</th>
                  <th scope="col" class="right" style="width: 90px;">P/L</th>
                  <th scope="col" style="width: 90px;">Tag</th>
                  <th scope="col" style="width: 120px;">Group</th>
                  <th scope="col" style="width: 110px;">Slip ID</th>

                  <th scope="col" class="right" style="width: 70px;">⋯</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
        </div>

        <!-- CARDS VIEW -->
        <div class="cardsWrap" id="cards"></div>
      </div>

      <!-- Right -->
      <div style="display:grid; gap: 14px;">
        <div class="card">
          <div class="section-title">
            <h2>KPIs</h2>
            <span class="hint">finished slips only</span>
          </div>
          <div class="row">
            <div class="col-6">
              <label for="viewDate">View Date</label>
              <input id="viewDate" type="date" />
            </div>
            <div class="col-6">
              <label for="bankroll">Starting Bankroll</label>
              <input id="bankroll" type="number" step="0.01" placeholder="1000" inputmode="decimal" />
            </div>
          </div>

          <div class="kpis" id="kpis" role="status" aria-live="polite"></div>
          <div class="bankline" id="bankrollLine" role="status" aria-live="polite"></div>
          <div class="chart-wrap">
            <canvas id="bankrollChart" width="640" height="200"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="section-title">
            <h2>Filters</h2>
            <span class="hint">find slips fast</span>
          </div>
          <div class="row">
            <div class="col-6">
              <label for="filterStatus">Status</label>
              <select id="filterStatus">
                <option value="ALL">All</option>
                <option value="PENDING">Pending</option>
                <option value="DONE">Finished</option>
              </select>
            </div>
            <div class="col-6">
              <label for="sortBy">Sort</label>
              <select id="sortBy">
                <option value="date_desc">Date (new → old)</option>
                <option value="date_asc">Date (old → new)</option>
                <option value="stake_desc">Stake (high → low)</option>
                <option value="stake_asc">Stake (low → high)</option>
              </select>
            </div>
            <div class="col-6">
              <label for="filterDate">Show only date</label>
              <select id="filterDate">
                <option value="ALL">All dates</option>
              </select>
            </div>
            <div class="col-6">

              <input id="search" type="text" placeholder="type to filter..." />
            </div>
            <div class="col-6">
              <label for="filterGroup">Group / Session</label>
              <select id="filterGroup">
                <option value="ALL">All groups</option>
              </select>
            </div>
            <div class="col-12">
              <label for="autosave">Auto-save</label>
              <select id="autosave">
                <option value="on">On (recommended)</option>
                <option value="off">Off (manual export only)</option>
              </select>
              <div class="muteline">If Auto-save is off, Export TXT so you never lose your log.</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Floating actions menu -->
  <div class="menu" id="menu">
    <div class="title">
      <div class="t" id="menuTitle">Slip Actions</div>
      <button class="x" id="menuClose" title="Close">×</button>
    </div>

    <div class="grid1">
      <small>Status / result</small>
      <div class="grid2">
        <button class="btn" id="actPending">Mark Pending</button>
        <button class="btn" id="actPush">Mark Push</button>
        <button class="btn" id="actWin">Mark Win</button>
        <button class="btn" id="actLoss">Mark Loss</button>
      </div>

      <div class="line"></div>

      <small>Paid multiplier (optional)</small>
      <div class="grid2">
        <input id="menuPaid" type="number" step="0.01" placeholder="e.g. 1.5" />
        <button class="btn" id="actSavePaid">Save Paid x</button>
      </div>

      <div class="line"></div>

      <button class="btn danger" id="actDelete">Delete Slip</button>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "slip_tracker_multipliers_pro_v2";

  let state = {
    startingBankroll: 0,
    autosave: "on",
    logView: "auto", // auto | table | cards
    slips: []
  };

  const $ = (id) => document.getElementById(id);

  const num = (v) => {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  };

  const todayISO = () => {
    const d = new Date();
    const p = (x) => String(x).padStart(2,'0');
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
  };

  const fmtMoney = (n) => num(n).toLocaleString(undefined, {style:"currency", currency:"USD"});
  const fmtPct = (n) => (Number.isFinite(n) ? (n*100).toFixed(1)+"%" : "0.0%");

  const escapeHtml = (s) => String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  const genId = () => (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2));

  const playersContainer = () => $("players");
  const playerRowTemplate = (player = {}, index = 0) => `
    <div class="row" data-player-row>
      <div class="col-6">
        <label>Player ${index + 1}</label>
        <input type="text" class="player-name" placeholder="Player name" value="${escapeHtml(player.name || "")}" />
      </div>
      <div class="col-3">
        <label>Prop Line</label>
        <input type="number" class="player-line" step="0.1" placeholder="15.5" value="${escapeHtml(player.line || "")}" />
      </div>
      <div class="col-3">
        <label>O/U</label>
        <select class="player-ou">
          <option value="">Select</option>
          <option value="Over" ${player.ou === "Over" ? "selected" : ""}>Over</option>
          <option value="Under" ${player.ou === "Under" ? "selected" : ""}>Under</option>
        </select>
        <button class="btn danger remove-player" type="button" title="Remove player" style="margin-top:10px; width:100%;">Remove</button>
      </div>
    </div>
  `;

  function renderPlayers(players){
    const container = playersContainer();
    if(!container) return;
    const list = players.length ? players : [{name:"", line:"", ou:""}];
    container.innerHTML = list.map((player, idx) => playerRowTemplate(player, idx)).join("");
  }

  function readPlayersDraft(){
    const container = playersContainer();
    if(!container) return [];
    return Array.from(container.querySelectorAll("[data-player-row]")).map(row => ({
      name: row.querySelector(".player-name")?.value.trim() || "",
      line: row.querySelector(".player-line")?.value.trim() || "",
      ou: row.querySelector(".player-ou")?.value || ""
    }));
  }

  function readPlayersFromForm(){
    const draft = readPlayersDraft();
    const players = [];
    for(const player of draft){
      const {name, line, ou} = player;
      if(!name && !line && !ou) continue;
      if(!name || !line || !ou){
        alert("Each player row needs a name, prop line, and over/under selection.");
        return null;
      }
      players.push({name, line, ou});
    }
    return players;
  }

  function setBodyView(){
    document.body.classList.remove("view-auto","view-table","view-cards");
    const v = state.logView || "auto";
    document.body.classList.add(v === "table" ? "view-table" : v === "cards" ? "view-cards" : "view-auto");
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const parsed = JSON.parse(raw);
      if(!parsed || typeof parsed !== "object") return;
      state.startingBankroll = num(parsed.startingBankroll);
      state.autosave = parsed.autosave === "off" ? "off" : "on";
      state.logView = (parsed.logView === "table" || parsed.logView === "cards") ? parsed.logView : "auto";
      state.slips = Array.isArray(parsed.slips) ? parsed.slips : [];
    }catch{}
  }

  function save(){
    if(state.autosave !== "on") return;
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{}
  }

  function payoutFor(s){
    if(s.status !== "DONE") return null;
    if(s.result === "L") return 0;
    if(s.result === "P") return num(s.stake);
    const paidOk = s.paidMult !== "" && s.paidMult !== null && s.paidMult !== undefined && Number.isFinite(Number(s.paidMult));
    const used = paidOk ? num(s.paidMult) : num(s.mult);
    return num(s.stake) * used;
  }

  function plFor(s){
    const p = payoutFor(s);
    if(p === null) return null;
    return p - num(s.stake);
  }

  function statusPill(s){
    if(s.status === "PENDING") return `<span class="pill pending">Pending</span>`;
    if(s.result === "W") return `<span class="pill win">Done • W</span>`;
    if(s.result === "L") return `<span class="pill loss">Done • L</span>`;
    return `<span class="pill push">Done • P</span>`;
  }

  function refreshDateDropdown(){
    const select = $("filterDate");
    const current = select.value;
    const dates = Array.from(new Set(state.slips.map(s => s.date).filter(Boolean))).sort().reverse();
    select.innerHTML = `<option value="ALL">All dates</option>` + dates.map(d => `<option value="${d}">${d}</option>`).join("");
    select.value = dates.includes(current) ? current : "ALL";
  }

  function refreshGroupDropdown(){
    const select = $("filterGroup");
    const current = select.value;
    const groups = Array.from(new Set(state.slips.map(s => s.group).filter(Boolean))).sort();
    select.innerHTML = `<option value="ALL">All groups</option>` + groups.map(g => `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("");
    select.value = groups.includes(current) ? current : "ALL";
  }

  function refreshDatalists(){
    const presets = {
      appList: ["PrizePicks", "Underdog", "FanDuel", "DraftKings", "BetMGM", "Caesars"],
      sportsbookList: ["FanDuel", "DraftKings", "BetMGM", "Caesars", "PointsBet", "WynnBET"],
      leagueList: ["NBA", "NFL", "NHL", "MLB", "NCAAF", "NCAAB", "Soccer", "WNBA", "MMA", "Tennis"],
      tagList: ["nba", "nfl", "nhl", "mlb", "props", "parlay", "live"],
      groupList: [],

    };

    const fromSlips = (key) => state.slips.map(s => s[key]).filter(Boolean);
    const merge = (preset, dynamic) => Array.from(new Set([...preset, ...dynamic])).sort();

    const lists = {
      appList: merge(presets.appList, fromSlips("app")),
      sportsbookList: merge(presets.sportsbookList, fromSlips("sportsbook")),
      leagueList: merge(presets.leagueList, fromSlips("league")),
      tagList: merge(presets.tagList, fromSlips("tag")),
      groupList: merge(presets.groupList, fromSlips("group")),

    };

    Object.entries(lists).forEach(([id, values]) => {
      const list = $(id);
      if(!list) return;
      list.innerHTML = values.map(v => `<option value="${escapeHtml(v)}"></option>`).join("");
    });
  }

  function applyFilters(list){
    const status = $("filterStatus").value;
    const query = $("search").value.trim().toLowerCase();
    const dateFilter = $("filterDate").value;
    const groupFilter = $("filterGroup").value;

    let out = list.slice();

    if(status === "PENDING") out = out.filter(s => s.status === "PENDING");
    if(status === "DONE") out = out.filter(s => s.status === "DONE");
    if(dateFilter !== "ALL") out = out.filter(s => s.date === dateFilter);
    if(groupFilter !== "ALL") out = out.filter(s => (s.group || "") === groupFilter);

    if(query){
      out = out.filter(s =>
        (s.app||"").toLowerCase().includes(query) ||
        (s.sportsbook||"").toLowerCase().includes(query) ||
        (s.league||"").toLowerCase().includes(query) ||
        (s.oddsType||"").toLowerCase().includes(query) ||
        (s.creator||"").toLowerCase().includes(query) ||
        (s.tag||"").toLowerCase().includes(query) ||
        (s.group||"").toLowerCase().includes(query) ||
        (s.slipId||"").toLowerCase().includes(query) ||
        (s.players || []).some(p => `${p.name} ${p.ou} ${p.line}`.toLowerCase().includes(query))
      );
    }

    const sortBy = $("sortBy").value;
    out.sort((a,b) => {
      if(sortBy === "date_desc") return (b.date||"").localeCompare(a.date||"") || (b.createdAt||0)-(a.createdAt||0);
      if(sortBy === "date_asc")  return (a.date||"").localeCompare(b.date||"") || (a.createdAt||0)-(b.createdAt||0);
      if(sortBy === "stake_desc") return num(b.stake)-num(a.stake);
      if(sortBy === "stake_asc")  return num(a.stake)-num(b.stake);
      return 0;
    });

    return out;
  }

  function kpiCard(label, valueHtml){
    const d = document.createElement("div");
    d.className = "kpi";
    d.innerHTML = `<div class="k">${label}</div><div class="v">${valueHtml}</div>`;
    return d;
  }

  function moneySpan(n){
    const v = num(n);
    const cls = v > 0 ? "pos" : (v < 0 ? "neg" : "neu");
    return `<span class="${cls}">${v >= 0 ? "+" : ""}${fmtMoney(v)}</span>`;
  }

  function render(){
    refreshDateDropdown();
    refreshGroupDropdown();
    refreshDatalists();
    setBodyView();

    $("bankroll").value = String(state.startingBankroll || "");
    $("autosave").value = state.autosave;
    $("logView").value = state.logView || "auto";

    const shown = applyFilters(state.slips);

    // TABLE
    const tbody = $("rows");
    tbody.innerHTML = "";
    for(const s of shown){
      const p = payoutFor(s);
      const pl = plFor(s);

      const payoutCell = (p === null) ? `<span style="color:rgba(255,255,255,.45)">—</span>` : fmtMoney(p);
      const plCell = (pl === null) ? `<span style="color:rgba(255,255,255,.45)">—</span>`
        : `<span class="${pl>0?'pos':(pl<0?'neg':'neu')}">${pl>=0?'+':''}${fmtMoney(pl)}</span>`;

      const paidCell = (s.paidMult === "" || s.paidMult === null || s.paidMult === undefined)
        ? `<span style="color:rgba(255,255,255,.45)">—</span>`
        : `<span class="mono">${num(s.paidMult).toFixed(2)}x</span>`;

    const playersText = (s.players || [])
      .map(p => `${p.name} ${p.ou} ${p.line}`)
      .join(" • ");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(s.date||"")}</td>
      <td>${statusPill(s)}</td>
      <td>${escapeHtml(s.app||"")}</td>
      <td>${escapeHtml(s.sportsbook||"")}</td>
      <td>${escapeHtml(s.league||"")}</td>
      <td>${escapeHtml(s.oddsType||"")}</td>
      <td>${escapeHtml(s.creator||"")}</td>
      <td class="right mono">${fmtMoney(s.stake)}</td>
      <td class="right mono">${num(s.mult).toFixed(2)}x</td>
      <td class="right">${paidCell}</td>
      <td class="right mono">${payoutCell}</td>
      <td class="right">${plCell}</td>
      <td>${escapeHtml(s.tag||"")}</td>
      <td>${escapeHtml(s.group||"")}</td>
      <td class="mono">${escapeHtml(s.slipId||"")}</td>
      <td class="notes-trunc" title="${escapeHtml(playersText)}">${escapeHtml(playersText)}</td>
      <td class="right">
        <button class="kebab" title="Actions" data-kebab="${s.id}">⋯</button>
      </td>
    `;
      tbody.appendChild(tr);
    }

    // CARDS
    const cards = $("cards");
    cards.innerHTML = "";
    for(const s of shown){
      const p = payoutFor(s);
      const pl = plFor(s);
      const payoutText = (p === null) ? "—" : fmtMoney(p);
      const plText = (pl === null) ? "—" : `${pl>=0?"+":""}${fmtMoney(pl)}`;
      const plCls = (pl === null) ? "neu" : (pl>0 ? "pos" : pl<0 ? "neg" : "neu");

      const paidText = (s.paidMult === "" || s.paidMult === null || s.paidMult === undefined) ? "—" : `${num(s.paidMult).toFixed(2)}x`;
      const playersList = (s.players || [])
        .map(p => `${p.name} ${p.ou} ${p.line}`)
        .join("\n");

      const el = document.createElement("div");
      el.className = "slipCard";
      el.innerHTML = `
        <div class="top">
          <div>
            <div class="meta">
              <span class="mono">${escapeHtml(s.date||"")}</span>
              ${statusPill(s)}
              ${s.app ? `<span>• ${escapeHtml(s.app)}</span>` : ""}
              ${s.sportsbook ? `<span>• ${escapeHtml(s.sportsbook)}</span>` : ""}
              ${s.league ? `<span>• ${escapeHtml(s.league)}</span>` : ""}
              ${s.oddsType ? `<span>• ${escapeHtml(s.oddsType)}</span>` : ""}
              ${s.tag ? `<span>• ${escapeHtml(s.tag)}</span>` : ""}
              ${s.group ? `<span>• ${escapeHtml(s.group)}</span>` : ""}
              ${s.creator ? `<span>• ${escapeHtml(s.creator)}</span>` : ""}
            </div>
          </div>
          <button class="kebab" title="Actions" data-kebab="${s.id}">⋯</button>
        </div>

        <div class="grid2">
          <div class="kv"><div class="k">Stake</div><div class="v mono">${fmtMoney(s.stake)}</div></div>
          <div class="kv"><div class="k">Multiplier</div><div class="v mono">${num(s.mult).toFixed(2)}x</div></div>
          <div class="kv"><div class="k">Paid x</div><div class="v mono">${paidText}</div></div>
          <div class="kv"><div class="k">Payout</div><div class="v mono">${payoutText}</div></div>
          <div class="kv"><div class="k">Profit/Loss</div><div class="v mono ${plCls}">${plText}</div></div>
          <div class="kv"><div class="k">Slip ID</div><div class="v mono">${escapeHtml(s.slipId||"—")}</div></div>
          <div class="kv"><div class="k">Group</div><div class="v mono">${escapeHtml(s.group||"—")}</div></div>
        </div>

        ${playersList ? `<div class="notes">${escapeHtml(playersList)}</div>` : ""}
      `;
      cards.appendChild(el);
    }

    // KPIs
    const view = $("viewDate").value || todayISO();
    const dayDone = state.slips.filter(s => s.date === view && s.status === "DONE");
    const dayStaked = dayDone.reduce((a,s)=>a+num(s.stake),0);
    const dayPaid = dayDone.reduce((a,s)=>a + (payoutFor(s) ?? 0),0);
    const dayNet = dayPaid - dayStaked;
    const dayRoi = dayStaked > 0 ? dayNet/dayStaked : 0;

    const done = state.slips.filter(s => s.status === "DONE");
    const allStaked = done.reduce((a,s)=>a+num(s.stake),0);
    const allPaid = done.reduce((a,s)=>a + (payoutFor(s) ?? 0),0);
    const allNet = allPaid - allStaked;
    const allRoi = allStaked > 0 ? allNet/allStaked : 0;
    const doneCount = done.length;
    const wins = done.filter(s => s.result === "W").length;
    const winRate = doneCount > 0 ? wins / doneCount : 0;
    const avgStake = doneCount > 0 ? allStaked / doneCount : 0;
    const avgMult = doneCount > 0 ? done.reduce((a,s)=>a+num(s.mult),0) / doneCount : 0;

    const pendingCount = state.slips.filter(s=>s.status==="PENDING").length;
    const endBankroll = num(state.startingBankroll) + allNet;

    const kpis = $("kpis");
    kpis.innerHTML = "";
    kpis.appendChild(kpiCard(`Selected Day Net (${view})`, moneySpan(dayNet)));
    kpis.appendChild(kpiCard(`Selected Day ROI`, `<span class="mono">${fmtPct(dayRoi)}</span>`));
    kpis.appendChild(kpiCard(`All-Time Net`, moneySpan(allNet)));
    kpis.appendChild(kpiCard(`All-Time ROI`, `<span class="mono">${fmtPct(allRoi)}</span>`));
    kpis.appendChild(kpiCard(`Win Rate`, `<span class="mono">${fmtPct(winRate)}</span>`));
    kpis.appendChild(kpiCard(`Avg Stake`, `<span class="mono">${fmtMoney(avgStake)}</span>`));
    kpis.appendChild(kpiCard(`Avg Multiplier`, `<span class="mono">${avgMult.toFixed(2)}x</span>`));
    kpis.appendChild(kpiCard(`Pending Slips`, `<span class="mono">${pendingCount}</span>`));

    $("bankrollLine").innerHTML =
      `Starting bankroll: <b class="mono">${fmtMoney(state.startingBankroll)}</b> → Current (finished slips): <b class="mono">${fmtMoney(endBankroll)}</b>`;

    renderBankrollChart(done, endBankroll);
  }

  function renderBankrollChart(done, endBankroll){
    const canvas = $("bankrollChart");
    if(!canvas) return;
    const ctx = canvas.getContext("2d");
    const width = canvas.width;
    const height = canvas.height;
    ctx.clearRect(0,0,width,height);

    if(done.length === 0){
      ctx.fillStyle = "rgba(255,255,255,0.55)";
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
      ctx.fillText("No finished slips yet.", 12, 20);
      return;
    }

    const sorted = done.slice().sort((a,b) => {
      const dateSort = (a.date||"").localeCompare(b.date||"");
      if(dateSort !== 0) return dateSort;
      return (a.createdAt||0) - (b.createdAt||0);
    });

    const points = [];
    let bank = num(state.startingBankroll);
    points.push(bank);
    for(const s of sorted){
      bank += plFor(s) ?? 0;
      points.push(bank);
    }

    const minVal = Math.min(...points);
    const maxVal = Math.max(...points);
    const range = Math.max(1, maxVal - minVal);
    const padding = 16;

    const xStep = (width - padding * 2) / Math.max(1, points.length - 1);
    const yFor = (val) => height - padding - ((val - minVal) / range) * (height - padding * 2);

    ctx.strokeStyle = "rgba(255,255,255,0.2)";
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height - padding);
    ctx.lineTo(width - padding, height - padding);
    ctx.stroke();

    ctx.strokeStyle = "rgba(110,168,255,0.85)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    points.forEach((val, i) => {
      const x = padding + i * xStep;
      const y = yFor(val);
      if(i === 0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();

    ctx.fillStyle = "rgba(255,255,255,0.65)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\",\"Courier New\", monospace";
    ctx.fillText(`End: ${fmtMoney(endBankroll)}`, padding, height - 6);
  }

  function readSlipFromForm(forcePending=false){
    const date = $("date").value || todayISO();
    const status = forcePending ? "PENDING" : $("status").value;
    const result = $("result").value;
    const app = $("app").value.trim();
    const sportsbook = $("sportsbook").value.trim();
    const league = $("league").value.trim();
    const oddsType = $("oddsType").value;
    const stake = num($("stake").value);
    const mult = num($("mult").value);
    const paidRaw = $("paid").value;
    const paidMult = (paidRaw === "" ? "" : num(paidRaw));
    const tag = $("tag").value.trim();
    const group = $("group").value.trim();
    const creator = $("creator").value;
    const slipId = $("slipId").value.trim();
    const players = readPlayersFromForm();
    if(players === null) return null;

    if(stake <= 0) return alert("Stake must be > 0"), null;
    if(mult <= 0) return alert("Listed multiplier must be > 0"), null;
    if(players.length === 0) return alert("Add at least one player/prop."), null;

    return {
      id: genId(),
      createdAt: Date.now(),
      date, status,
      result: status==="DONE" ? result : "",
      app, sportsbook, league, oddsType,
      creator, stake, mult, paidMult, tag, group, slipId, players
    };
  }

  function clearForm(){
    $("app").value = "";
    $("sportsbook").value = "";
    $("league").value = "";
    $("oddsType").value = "";
    $("stake").value = "";
    $("mult").value = "";
    $("paid").value = "";
    $("tag").value = "";
    $("group").value = "";
    $("slipId").value = "";
    $("creator").value = "CHUY";
    renderPlayers([]);
  }

  // Import/Export
  function downloadFile(filename, content, mime){
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  function exportTxt(){
    const payload = {
      version: 2,
      exportedAt: new Date().toISOString(),
      startingBankroll: state.startingBankroll,
      autosave: state.autosave,
      logView: state.logView,
      slips: state.slips
    };
    downloadFile(`slips-${todayISO()}.txt`, JSON.stringify(payload,null,2), "text/plain");
  }

  function exportCsv(){
    const cols = ["date","status","result","app","sportsbook","league","oddsType","creator","stake","mult","paidMult","payout","profitLoss","tag","group","slipId","players"];
    const lines = [cols.join(",")];
    for(const s of state.slips){
      const p = payoutFor(s);
      const pl = plFor(s);
      const playersCsv = (s.players || [])
        .map(player => `${player.name} ${player.ou} ${player.line}`)
        .join(" | ");
      const row = [
        s.date, s.status, s.result, s.app, s.sportsbook, s.league, s.oddsType, s.creator,
        s.stake, s.mult, (s.paidMult===""? "" : s.paidMult),
        (p===null? "" : p),
        (pl===null? "" : pl),
        s.tag, s.group, s.slipId,
        playersCsv
      ].map(v => {
        const str = String(v ?? "");
        return /[",\n]/.test(str) ? `"${str.replaceAll('"','""')}"` : str;
      });
      lines.push(row.join(","));
    }
    downloadFile(`slips-${todayISO()}.csv`, lines.join("\n"), "text/csv");
  }

  async function importTxt(file){
    try{
      const text = await file.text();
      const parsed = JSON.parse(text);

      if(parsed.startingBankroll !== undefined) state.startingBankroll = num(parsed.startingBankroll);
      state.autosave = parsed.autosave === "off" ? "off" : "on";
      state.logView = (parsed.logView === "table" || parsed.logView === "cards") ? parsed.logView : "auto";

      if(Array.isArray(parsed.slips)) state.slips = parsed.slips;

      // normalize
      state.slips = state.slips.map(s => ({
        id: s.id || genId(),
        createdAt: s.createdAt || Date.now(),
        date: s.date || "",
        status: s.status === "DONE" ? "DONE" : "PENDING",
        result: s.result || "",
        app: s.app || "",
        sportsbook: s.sportsbook || "",
        league: s.league || "",
        oddsType: s.oddsType || "",
        creator: s.creator || "CHUY",
        stake: num(s.stake),
        mult: num(s.mult),
        paidMult: (s.paidMult === undefined ? "" : s.paidMult),
        tag: s.tag || "",
        group: s.group || "",
        slipId: s.slipId || "",
        players: Array.isArray(s.players) ? s.players : ((s.notes && !s.players) ? [{name: s.notes, line: "", ou: ""}] : [])
      }));

      save();
      render();
    }catch{
      alert("Import failed. Use a file exported from this tracker.");
    }
  }

  // ---- Kebab menu logic ----
  const menu = $("menu");
  const menuTitle = $("menuTitle");
  const menuPaid = $("menuPaid");
  let activeSlipId = null;

  function closeMenu(){
    menu.style.display = "none";
    activeSlipId = null;
  }

  function openMenuForSlip(slipId, anchorRect){
    const s = state.slips.find(x => x.id === slipId);
    if(!s) return;

    activeSlipId = slipId;
    menuTitle.textContent = `Slip • ${s.date} • ${fmtMoney(s.stake)} @ ${num(s.mult).toFixed(2)}x`;
    menuPaid.value = (s.paidMult === "" || s.paidMult === null || s.paidMult === undefined) ? "" : String(s.paidMult);

    // Mobile: bottom sheet handled by CSS, just show
    if(window.matchMedia("(max-width: 600px)").matches){
      menu.style.display = "block";
      return;
    }

    // Desktop positioning near kebab
    const margin = 10;
    const width = 330;
    const heightGuess = 300;

    let left = anchorRect.right + margin;
    if(left + width > window.innerWidth - 10) left = anchorRect.left - width - margin;
    left = Math.max(10, Math.min(left, window.innerWidth - width - 10));

    let top = anchorRect.top;
    if(top + heightGuess > window.innerHeight - 10) top = window.innerHeight - heightGuess - 10;
    top = Math.max(10, top);

    menu.style.left = left + "px";
    menu.style.top = top + "px";
    menu.style.display = "block";
  }

  function setSlipStatusResult(id, status, result){
    const s = state.slips.find(x => x.id === id);
    if(!s) return;
    s.status = status;
    s.result = status === "DONE" ? result : "";
    save(); render();
  }

  function setPaidMult(id, val){
    const s = state.slips.find(x => x.id === id);
    if(!s) return;
    s.paidMult = (val === "" ? "" : num(val));
    save(); render();
  }

  function deleteSlip(id){
    state.slips = state.slips.filter(s => s.id !== id);
    save(); render();
  }

  // Events
  $("addBtn").addEventListener("click", () => {
    const slip = readSlipFromForm(false);
    if(!slip) return;
    if(slip.status === "DONE" && !slip.result) return alert("Pick a result for finished slips.");
    state.slips.push(slip);
    save(); clearForm(); render();
  });

  $("addPendingBtn").addEventListener("click", () => {
    const slip = readSlipFromForm(true);
    if(!slip) return;
    slip.status = "PENDING"; slip.result = "";
    state.slips.push(slip);
    save(); clearForm(); render();
  });

  $("clearBtn").addEventListener("click", () => {
    if(!confirm("Clear ALL slips?")) return;
    state.slips = [];
    save(); render();
  });

  $("addPlayerBtn").addEventListener("click", () => {
    const current = readPlayersDraft();
    current.push({name:"", line:"", ou:""});
    renderPlayers(current);
  });

  playersContainer().addEventListener("click", (e) => {
    if(!e.target.closest(".remove-player")) return;
    const rows = Array.from(playersContainer().querySelectorAll("[data-player-row]"));
    const row = e.target.closest("[data-player-row]");
    const index = rows.indexOf(row);
    const current = readPlayersDraft();
    current.splice(index, 1);
    renderPlayers(current);
  });

  $("exportBtn").addEventListener("click", exportTxt);
  $("exportCsvBtn").addEventListener("click", exportCsv);

  $("importFile").addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if(file) await importTxt(file);
    e.target.value = "";
  });

  $("bankroll").addEventListener("input", (e) => {
    state.startingBankroll = num(e.target.value);
    save(); render();
  });

  $("autosave").addEventListener("change", (e) => {
    state.autosave = e.target.value;
    if(state.autosave === "on") save();
  });

  $("logView").addEventListener("change", (e) => {
    state.logView = e.target.value;
    save(); render();
  });

  $("viewDate").addEventListener("change", render);
  $("filterStatus").addEventListener("change", render);
  $("filterDate").addEventListener("change", render);
  $("filterGroup").addEventListener("change", render);
  $("sortBy").addEventListener("change", render);
  $("search").addEventListener("input", render);

  $("status").addEventListener("change", () => {
    const done = $("status").value === "DONE";
    $("result").disabled = !done;
  });

  // open kebab menu (works for table + cards)
  document.addEventListener("click", (e) => {
    const kb = e.target.closest("[data-kebab]");
    if(kb){
      const id = kb.getAttribute("data-kebab");
      const rect = kb.getBoundingClientRect();
      if(activeSlipId === id && menu.style.display === "block") closeMenu();
      else openMenuForSlip(id, rect);
      return;
    }
    if(menu.style.display === "block" && !e.target.closest("#menu")) closeMenu();
  });

  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape") closeMenu();
  });

  $("menuClose").addEventListener("click", closeMenu);

  $("actPending").addEventListener("click", () => { if(activeSlipId){ setSlipStatusResult(activeSlipId,"PENDING",""); closeMenu(); }});
  $("actWin").addEventListener("click", () => { if(activeSlipId){ setSlipStatusResult(activeSlipId,"DONE","W"); closeMenu(); }});
  $("actLoss").addEventListener("click", () => { if(activeSlipId){ setSlipStatusResult(activeSlipId,"DONE","L"); closeMenu(); }});
  $("actPush").addEventListener("click", () => { if(activeSlipId){ setSlipStatusResult(activeSlipId,"DONE","P"); closeMenu(); }});
  $("actSavePaid").addEventListener("click", () => { if(activeSlipId){ setPaidMult(activeSlipId, menuPaid.value); closeMenu(); }});
  $("actDelete").addEventListener("click", () => {
    if(!activeSlipId) return;
    if(!confirm("Delete this slip?")) return;
    deleteSlip(activeSlipId);
    closeMenu();
  });

  // Init
  load();
  $("date").value = todayISO();
  $("viewDate").value = todayISO();
  $("result").disabled = ($("status").value !== "DONE");
  $("creator").value = "CHUY";
  renderPlayers([]);
  render();

  // re-render on resize (so Auto view switches smoothly)
  window.addEventListener("resize", () => {
    if(state.logView === "auto") setBodyView();
  });
})();
</script>
</body>
</html>
